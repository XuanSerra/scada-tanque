<!-- Reemplaza el <script> al final del index.html anterior con este: -->
<script>
    const totalLiters = 443730; // Capacidad total inicial en litros
    const tank = document.getElementById("water-level");
    const litersDisplay = document.getElementById("liters");
    const m3Display = document.getElementById("m3");
    const slider = document.getElementById("level-slider");
    const sliderContainer = document.getElementById("slider-container");
    const pipePump = document.getElementById("pipe-pump");
    const pumpIcon = document.getElementById("pump-icon");
    const pumpToggle = document.getElementById("pump-toggle");
    const pumpCounterDisplay = document.getElementById("pump-counter");
    const resetCounter = document.getElementById("reset-counter");
    const simulationControls = document.getElementById("simulation-controls");
    const weekNumberDisplay = document.getElementById("week-number");
    const periodDisplay = document.getElementById("period");
    const configBtn = document.getElementById("config-btn");
    const configModal = document.getElementById("config-modal");
    const saveConfig = document.getElementById("save-config");
    const closeConfig = document.getElementById("close-config");
    const alarm = document.getElementById("alarm");
    const ctx = document.getElementById('levelChart').getContext('2d');
    const tiltToggle = document.getElementById("tilt-toggle");

    // Cargar configuración inicial desde localStorage o valores por defecto
    let config = JSON.parse(localStorage.getItem('config')) || {
        capacity: 443730,
        color100: '#00008B',
        color75: '#ADD8E6',
        color50: '#FFA500',
        color25: '#FFFF00',
        color15: '#FF0000',
        alarmThreshold: 15,
        showSimulation: false,
        efento: {
            email: 'contadorsranxos@gmail.com',
            password: 'Ranxos2024@J@',
            token: '',
            orgID: '',
            locationID: '',
            measurementID: ''
        }
    };

    let currentCapacity = config.capacity;
    let defaultColors = {
        100: config.color100,
        75: config.color75,
        50: config.color50,
        25: config.color25,
        15: config.color15
    };
    let alarmThreshold = config.alarmThreshold;
    let showSimulation = config.showSimulation;

    // Inicializar el número de semana y periodo (fecha actual)
    const today = new Date();
    const weekNumber = getWeekNumber(today);
    const period = today.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }).replace(' de ', ' ');
    weekNumberDisplay.textContent = weekNumber;
    periodDisplay.textContent = period.charAt(0).toUpperCase() + period.slice(1);

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
    }

    // Actualizar el nivel del tanque y los valores según el slider
    slider.addEventListener("input", function() {
        const liters = parseInt(slider.value);
        const percentage = (liters / currentCapacity) * 100;
        updateTank(liters, percentage);
        checkAlarm(percentage);
    });

    function updateTank(liters, percentage) {
        tank.style.height = percentage + "%"; // Mantiene el tanque vertical
        litersDisplay.textContent = liters;
        m3Display.textContent = (liters / 1000).toFixed(3); // Convertir litros a m³
        updateWaterColor(percentage);
        updateChart(liters / 1000); // Pasar m³ al gráfico
    }

    // Colores del agua según rangos
    function updateWaterColor(percentage) {
        if (percentage >= 75) tank.style.backgroundColor = defaultColors[100];
        else if (percentage >= 60) tank.style.backgroundColor = defaultColors[75];
        else if (percentage >= 40) tank.style.backgroundColor = defaultColors[50];
        else if (percentage >= 20) tank.style.backgroundColor = defaultColors[25];
        else tank.style.backgroundColor = defaultColors[15];
    }

    // Simular ON/OFF de la bomba y contar veces
    let pumpOn = false;
    let pumpCounter = 0;
    pumpToggle.addEventListener("click", function() {
        pumpOn = !pumpOn;
        if (pumpOn) {
            pipePump.style.backgroundColor = "green"; // Tubo y bomba ON (verde)
            pumpIcon.style.backgroundColor = "green"; // Icono de la bomba también verde
            pumpToggle.textContent = "Simular Bomba OFF";
        } else {
            pipePump.style.backgroundColor = "white"; // Tubo y bomba STOP (blanco)
            pumpIcon.style.backgroundColor = "white"; // Icono de la bomba también blanco
            pumpToggle.textContent = "Simular Bomba ON";
        }
        pumpCounter++;
        pumpCounterDisplay.textContent = pumpCounter;
    });

    // Resetear contador de ON/OFF
    resetCounter.addEventListener("click", function() {
        pumpCounter = 0;
        pumpCounterDisplay.textContent = pumpCounter;
    });

    // Configuración
    configBtn.addEventListener("click", function() {
        configModal.classList.add("show");
        document.getElementById("capacity").value = config.capacity;
        document.getElementById("color100").value = config.color100;
        document.getElementById("color75").value = config.color75;
        document.getElementById("color50").value = config.color50;
        document.getElementById("color25").value = config.color25;
        document.getElementById("color15").value = config.color15;
        document.getElementById("alarmThreshold").value = config.alarmThreshold;
        tiltToggle.checked = !config.showSimulation; // Invertido para "Mostrar teclas simulación"
    });

    closeConfig.addEventListener("click", function() {
        configModal.classList.remove("show");
    });

    saveConfig.addEventListener("click", function() {
        config.capacity = parseInt(document.getElementById("capacity").value) || 443730;
        config.color100 = document.getElementById("color100").value;
        config.color75 = document.getElementById("color75").value;
        config.color50 = document.getElementById("color50").value;
        config.color25 = document.getElementById("color25").value;
        config.color15 = document.getElementById("color15").value;
        config.alarmThreshold = parseInt(document.getElementById("alarmThreshold").value) || 15;
        config.showSimulation = !tiltToggle.checked; // Invertido: ON oculta, OFF muestra
        config.efento.email = prompt("Correo de EFENTO (dejar vacío para no cambiar):") || config.efento.email;
        config.efento.password = prompt("Contraseña de EFENTO (dejar vacío para no cambiar):") || config.efento.password;
        config.efento.token = prompt("Token de EFENTO (dejar vacío para no cambiar):") || config.efento.token;
        config.efento.orgID = prompt("ID de Organización de EFENTO (dejar vacío para no cambiar):") || config.efento.orgID;
        config.efento.locationID = prompt("ID de Ubicación de EFENTO (dejar vacío para no cambiar):") || config.efento.locationID;
        config.efento.measurementID = prompt("ID de Medición de EFENTO (dejar vacío para no cambiar):") || config.efento.measurementID;

        localStorage.setItem('config', JSON.stringify(config));
        currentCapacity = config.capacity;
        defaultColors[100] = config.color100;
        defaultColors[75] = config.color75;
        defaultColors[50] = config.color50;
        defaultColors[25] = config.color25;
        defaultColors[15] = config.color15;
        alarmThreshold = config.alarmThreshold;
        toggleSimulationMode(config.showSimulation);
        configModal.classList.remove("show");
        const liters = parseInt(slider.value);
        const percentage = (liters / currentCapacity) * 100;
        updateTank(liters, percentage);
        checkAlarm(percentage);
    });

    let alarmThreshold = config.alarmThreshold; // Umbral inicial para alarma

    function checkAlarm(percentage) {
        if (percentage <= alarmThreshold) {
            alarm.style.display = "block";
            tank.classList.add("blink"); // Activar intermitencia del agua
            alarm.innerHTML = `¡Alarma! Nivel bajo en Depósito 1 - ${percentage.toFixed(1)}% <br>
                <a href="mailto:?subject=Alarma%20Depósito%201&body=Nivel%20bajo:%20${percentage.toFixed(1)}%" target="_blank">Enviar Email</a> | 
                <a href="https://wa.me/?text=Alarma%20Depósito%201:%20Nivel%20bajo%20${percentage.toFixed(1)}%" target="_blank">Enviar WhatsApp</a> | 
                <span>Simular SMS (no real, configúralo manualmente)</span>`;
        } else {
            alarm.style.display = "none";
            tank.classList.remove("blink"); // Desactivar intermitencia del agua
        }
    }

    function toggleSimulationMode(showSimulation) {
        if (showSimulation) {
            sliderContainer.style.display = "inline-block";
            simulationControls.style.display = "block";
        } else {
            sliderContainer.style.display = "none";
            simulationControls.style.display = "none";
        }
    }

    // Gráfico simulado en m³
    let chart;
    const labels = Array.from({ length: 10 }, (_, i) => `Día ${i + 1}`);
    const data = {
        labels: labels,
        datasets: [{
            label: 'Nivel de agua (m³)',
            data: [400.000, 380.000, 360.000, 340.000, 320.000, 300.000, 280.000, 260.000, 240.000, 221.865],
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true
        }]
    };

    chart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 443.730 } }
        }
    });

    function updateChart(m3) {
        chart.data.datasets[0].data.shift();
        chart.data.datasets[0].data.push(m3);
        chart.update();
    }

    // Inicializar el tanque al 50%
    slider.value = 221865;
    slider.dispatchEvent(new Event("input"));
    pipePump.style.backgroundColor = "white"; // Tubo y bomba iniciales en STOP
    pumpIcon.style.backgroundColor = "white"; // Icono de la bomba inicial en blanco
    pumpToggle.textContent = "Simular Bomba ON";
    pumpCounterDisplay.textContent = pumpCounter;
    toggleSimulationMode(config.showSimulation); // Mostrar u ocultar según configuración inicial
</script>
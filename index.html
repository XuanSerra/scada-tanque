<script>
    const totalLiters = 443730; // Capacidad total inicial en litros
    const tank = document.getElementById("water-level");
    const litersDisplay = document.getElementById("liters");
    const m3Display = document.getElementById("m3");
    const slider = document.getElementById("level-slider");
    const sliderContainer = document.getElementById("slider-container");
    const pipePump = document.getElementById("pipe-pump");
    const pumpIcon = document.getElementById("pump-icon");
    const pumpToggle = document.getElementById("pump-toggle");
    const pumpCounterDisplay = document.getElementById("pump-counter");
    const resetCounter = document.getElementById("reset-counter");
    const simulationControls = document.getElementById("simulation-controls");
    const weekNumberDisplay = document.getElementById("week-number");
    const periodDisplay = document.getElementById("period");
    const configBtn = document.getElementById("config-btn");
    const configModal = document.getElementById("config-modal");
    const saveConfig = document.getElementById("save-config");
    const closeConfig = document.getElementById("close-config");
    const alarm = document.getElementById("alarm");
    const ctx = document.getElementById('levelChart').getContext('2d');
    const tiltToggle = document.getElementById("tilt-toggle");

    // Inicializar el número de semana y periodo (fecha actual)
    const today = new Date();
    const weekNumber = getWeekNumber(today);
    const period = today.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }).replace(' de ', ' ');
    weekNumberDisplay.textContent = weekNumber;
    periodDisplay.textContent = period.charAt(0).toUpperCase() + period.slice(1);

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
    }

    // Procesar datos del Webhook
    function handleWebhookData(event) {
        try {
            const data = JSON.parse(event.data);
            let channel1MA = null;
            let channel2MA = null;

            data.measurementsEvents.forEach(channel => {
                if (channel.channelNumber === 1) {
                    channel1MA = channel.events[0].value; // mA del Canal 1
                } else if (channel.channelNumber === 2) {
                    channel2MA = channel.events[0].value; // mA del Canal 2
                }
            });

            if (channel1MA !== null) {
                const liters = maToLiters(channel1MA);
                const percentage = (liters / totalLiters) * 100;
                updateTank(liters, percentage);
                checkAlarm(percentage);
                console.log(`Canal 1: ${channel1MA} mA, ${liters} litros`);
            }

            if (channel2MA !== null) {
                console.log(`Canal 2: ${channel2MA} mA`); // Para interruptores
                // Lógica para interruptores se añadirá con más datos
            }
        } catch (error) {
            console.error('Error procesando Webhook:', error);
        }
    }

    // Convertir mA a litros
    function maToLiters(ma) {
        if (ma < 4) ma = 4; // Mínimo 4 mA
        if (ma > 20) ma = 20; // Máximo 20 mA
        const meters = (ma - 4) * (3 / 16); // mA a metros (4-20 mA = 0-3 m)
        const liters = meters * (totalLiters / 3); // Metros a litros
        return Math.min(liters, totalLiters); // Límite a capacidad máxima
    }

    // Simulación de Webhook con datos reales
    function simulateWebhook() {
        const event = new MessageEvent('message', { data: JSON.stringify({
            deviceSerialNumber: "282C0242368E",
            measurementsEvents: [
                { channelNumber: 1, events: [{ value: 5.003, timestamp: new Date().toISOString() }] },
                { channelNumber: 2, events: [{ value: 1.087, timestamp: new Date().toISOString() }] }
            ]
        }) });
        handleWebhookData(event);
    }
    simulateWebhook(); // Inicio con los datos que me diste
    setInterval(simulateWebhook, 300000); // Actualizar cada 5 minutos (300000 ms)

    // Actualizar el nivel del tanque y los valores
    function updateTank(liters, percentage) {
        tank.style.height = percentage + "%";
        litersDisplay.textContent = Math.round(liters);
        m3Display.textContent = (liters / 1000).toFixed(3);
        updateWaterColor(percentage);
        updateChart(liters / 1000);
    }

    // Colores del agua según rangos
    const defaultColors = {
        100: '#00008B', // Azul Marino
        75: '#ADD8E6',  // Azul Claro
        50: '#FFA500',  // Naranja
        25: '#FFFF00',  // Por debajo del 50% hasta 0
        15: '#FF0000'   // Color alarma nivel mínimo
    };

    function updateWaterColor(percentage) {
        if (percentage >= 75) tank.style.backgroundColor = defaultColors[100];
        else if (percentage >= 60) tank.style.backgroundColor = defaultColors[75];
        else if (percentage >= 40) tank.style.backgroundColor = defaultColors[50];
        else if (percentage >= 20) tank.style.backgroundColor = defaultColors[25];
        else tank.style.backgroundColor = defaultColors[15];
    }

    // Simular ON/OFF de la bomba y contar veces
    let pumpOn = false;
    let pumpCounter = 0;
    pumpToggle.addEventListener("click", function() {
        pumpOn = !pumpOn;
        if (pumpOn) {
            pipePump.style.backgroundColor = "green";
            pumpIcon.style.backgroundColor = "green";
            pumpToggle.textContent = "Simular Bomba OFF";
        } else {
            pipePump.style.backgroundColor = "white";
            pumpIcon.style.backgroundColor = "white";
            pumpToggle.textContent = "Simular Bomba ON";
        }
        pumpCounter++;
        pumpCounterDisplay.textContent = pumpCounter;
    });

    // Resetear contador de ON/OFF
    resetCounter.addEventListener("click", function() {
        pumpCounter = 0;
        pumpCounterDisplay.textContent = pumpCounter;
    });

    // Configuración
    configBtn.addEventListener("click", function() {
        configModal.classList.add("show");
    });

    closeConfig.addEventListener("click", function() {
        configModal.classList.remove("show");
    });

    saveConfig.addEventListener("click", function() {
        currentCapacity = parseInt(document.getElementById("capacity").value) || 443730;
        defaultColors[100] = document.getElementById("color100").value;
        defaultColors[75] = document.getElementById("color75").value;
        defaultColors[50] = document.getElementById("color50").value;
        defaultColors[25] = document.getElementById("color25").value;
        defaultColors[15] = document.getElementById("color15").value;
        alarmThreshold = parseInt(document.getElementById("alarmThreshold").value) || 15;
        const showSimulation = tiltToggle.checked; // ON muestra, OFF oculta
        toggleSimulationMode(showSimulation);
        configModal.classList.remove("show");
        const liters = parseInt(slider.value);
        const percentage = (liters / currentCapacity) * 100;
        updateTank(liters, percentage);
        checkAlarm(percentage);
    });

    let alarmThreshold = 15; // Umbral inicial para alarma

    function checkAlarm(percentage) {
        if (percentage <= alarmThreshold) {
            alarm.style.display = "block";
            tank.classList.add("blink"); // Activar intermitencia del agua
            alarm.innerHTML = `¡Alarma! Nivel bajo en Depósito 1 - ${percentage.toFixed(1)}% <br>
                <a href="mailto:?subject=Alarma%20Depósito%201&body=Nivel%20bajo:%20${percentage.toFixed(1)}%" target="_blank">Enviar Email</a> | 
                <a href="https://wa.me/?text=Alarma%20Depósito%201:%20Nivel%20bajo%20${percentage.toFixed(1)}%" target="_blank">Enviar WhatsApp</a> | 
                <span>Simular SMS (no real, configúralo manualmente)</span>`;
        } else {
            alarm.style.display = "none";
            tank.classList.remove("blink"); // Desactivar intermitencia del agua
        }
    }

    function toggleSimulationMode(showSimulation) {
        if (showSimulation) {
            sliderContainer.style.display = "inline-block";
            simulationControls.style.display = "block";
        } else {
            sliderContainer.style.display = "none";
            simulationControls.style.display = "none";
        }
    }

    // Gráfico simulado en m³
    let chart;
    const labels = Array.from({ length: 10 }, (_, i) => `Día ${i + 1}`);
    const data = {
        labels: labels,
        datasets: [{
            label: 'Nivel de agua (m³)',
            data: [400.000, 380.000, 360.000, 340.000, 320.000, 300.000, 280.000, 260.000, 240.000, 221.865],
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true
        }]
    };

    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('levelChart').getContext('2d');
        if (ctx) {
            chart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 443.730 } }
                }
            });
        } else {
            console.error('No se pudo encontrar el canvas "levelChart"');
        }
    });

    function updateChart(m3) {
        if (chart) {
            chart.data.datasets[0].data.shift();
            chart.data.datasets[0].data.push(m3);
            chart.update();
        }
    }

    // Inicializar el tanque al 50%
    slider.value = 221865;
    slider.dispatchEvent(new Event("input"));
    pipePump.style.backgroundColor = "white"; // Tubo y bomba iniciales en STOP
    pumpIcon.style.backgroundColor = "white"; // Icono de la bomba inicial en blanco
    pumpToggle.textContent = "Simular Bomba ON";
    pumpCounterDisplay.textContent = pumpCounter;
    simulationControls.style.display = "block"; // Mostrar controles de simulación inicialmente
    tiltToggle.checked = false; // "Mostrar teclas simulación" inicialmente desactivado (OFF)
</script>